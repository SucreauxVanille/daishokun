<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>大小君</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    button { font-size: 24px; margin: 20px; padding: 10px 20px; }
    #message, #streak { margin-top: 20px; font-size: 24px; }
    .correct { background-color: lightgreen; }
    .wrong { background-color: lightcoral; }
    .dimmed { background-color: lightgray; }
    #timer { font-size: 20px; color: darkorange; margin-top: 10px; }
    #nextBtn { display: none; margin-top: 20px; font-size: 20px; padding: 8px 16px; }
    #streak { color: blue; }
  </style>
</head>
<body>

  <h1>大きいのはどっち？</h1>
  <div id="question"></div>
  <div id="buttons"></div>
  <div id="timer"></div>
  <div id="message"></div>
  <div id="streak"></div>
  <button id="nextBtn" onclick="startGame()">次に進む</button>

  <script>
    let correctStreak = 0;
    let timer;
    let countdown;

    function generateM() {
      const operations = ['+', '-', '*', '/'];
      const maxAttempts = 100;
      let attempts = 0;
      while (attempts < maxAttempts) {
        let a = Math.floor(Math.random() * 200) + 1;
        let b = Math.floor(Math.random() * 100) + 1;
        if (a < b) [a, b] = [b, a]; // a >= b を保証

        let op = operations[Math.floor(Math.random() * operations.length)];
        let val, expr;

        switch (op) {
          case '+':
            val = a + b;
            expr = `${a} + ${b}`;
            break;
          case '-':
            val = a - b;
            if (val <= 0) break;
            expr = `${a} - ${b}`;
            break;
          case '*':
            val = a * b;
            expr = `${a} × ${b}`;
            break;
          case '/':
            if (b === 0 || a % b !== 0) break;
            val = a / b;
            expr = `${a} ÷ ${b}`;
            break;
        }

        if (val > 50 && val <= 1000) {
          return { val, expr };
        }
        attempts++;
      }
      return null; // 最大試行数に達した場合
    }

    function generateQuestion() {
      clearInterval(countdown);
      document.getElementById("timer").textContent = "";
      document.getElementById("message").textContent = "";
      document.getElementById("streak").textContent = "";
      document.getElementById("nextBtn").style.display = "none";

      const mData = generateM();
      if (!mData) {
        document.getElementById("question").textContent = "問題の生成に失敗しました。ページを再読み込みしてください。";
        document.getElementById("buttons").innerHTML = "";
        return;
      }

      const m = mData.val;
      let n = 100 * Math.floor(Math.random() * 10 + 1);
      if (Math.abs(m - n) >= 100 || m === n) {
        let attempts = 0;
        while ((Math.abs(m - n) >= 100 || m === n) && attempts < 50) {
          n = 100 * Math.floor(Math.random() * 10 + 1);
          attempts++;
        }
      }

      const isMFirst = Math.random() < 0.5;
      const left = isMFirst ? { val: m, label: mData.expr } : { val: n, label: n };
      const right = isMFirst ? { val: n, label: n } : { val: m, label: mData.expr };

      document.getElementById("question").textContent = "大きいのはどっち？";

      document.getElementById("buttons").innerHTML = `
        <button id="leftBtn">${left.label}</button>
        <button id="rightBtn">${right.label}</button>
      `;

      document.getElementById("leftBtn").onclick = () => checkAnswer(left, right, "leftBtn", "rightBtn");
      document.getElementById("rightBtn").onclick = () => checkAnswer(right, left, "rightBtn", "leftBtn");

      startTimer(left, right, "leftBtn", "rightBtn");
    }

    function checkAnswer(selected, other, selectedId, otherId) {
      clearInterval(countdown);
      document.getElementById("leftBtn").disabled = true;
      document.getElementById("rightBtn").disabled = true;

      const selectedBtn = document.getElementById(selectedId);
      const otherBtn = document.getElementById(otherId);

      if (selected.val > other.val) {
        selectedBtn.classList.add("correct");
        correctStreak++;
        document.getElementById("message").textContent = "正解！";
      } else {
        selectedBtn.classList.add("wrong");
        selectedBtn.classList.add("dimmed");
        otherBtn.classList.add("correct");
        correctStreak = 0;
        document.getElementById("message").textContent = "不正解！";
      }

      document.getElementById("streak").textContent = `現在 ${correctStreak} 問連続正解中！`;
      document.getElementById("nextBtn").style.display = "inline-block";
    }

    function startTimer(left, right, leftId, rightId) {
      let time = 10;
      document.getElementById("timer").textContent = `残り時間: ${time} 秒`;
      countdown = setInterval(() => {
        time--;
        if (time > 0) {
          document.getElementById("timer").textContent = `残り時間: ${time} 秒`;
        } else {
          clearInterval(countdown);
          document.getElementById("timer").textContent = "時間切れです！";
          document.getElementById(leftId).disabled = true;
          document.getElementById(rightId).disabled = true;

          if (left.val > right.val) {
            document.getElementById(leftId).classList.add("correct");
            document.getElementById(rightId).classList.add("dimmed");
          } else {
            document.getElementById(rightId).classList.add("correct");
            document.getElementById(leftId).classList.add("dimmed");
          }

          correctStreak = 0;
          document.getElementById("message").textContent = `正解は「${Math.max(left.val, right.val)}」でした。`;
          document.getElementById("streak").textContent = `現在 ${correctStreak} 問連続正解中！`;
          document.getElementById("nextBtn").style.display = "inline-block";
        }
      }, 1000);
    }

    function startGame() {
      generateQuestion();
    }

    window.onload = startGame;
  </script>
</body>
</html>
