<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>大小君</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 2em; }
    button { font-size: 1.5em; padding: 1em 2em; margin: 1em; }
    .correct { background-color: lightgreen; }
    .incorrect { background-color: lightcoral; }
    .neutral { background-color: lightgray; }
    #message { font-size: 1.2em; margin-top: 1em; }
    #streak { font-size: 1.2em; color: blue; margin-top: 1em; }
    #nextBtn { margin-top: 2em; font-size: 1em; padding: 0.5em 1.5em; }
    #timer { font-size: 1.2em; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>大きいのはどっち？</h1>
  <div id="question"></div>
  <button id="btn1"></button>
  <button id="btn2"></button>
  <div id="message"></div>
  <div id="streak">現在0問連続正解中！</div>
  <div id="timer">残り時間: 10秒</div>
  <button id="nextBtn" style="display:none;">次に進む</button>

  <script>
    const btn1 = document.getElementById('btn1');
    const btn2 = document.getElementById('btn2');
    const question = document.getElementById('question');
    const message = document.getElementById('message');
    const streakDisplay = document.getElementById('streak');
    const nextBtn = document.getElementById('nextBtn');
    const timerDisplay = document.getElementById('timer');

    let m, n, correctAnswer;
    let timer;
    let countdownTimer;
    let streak = 0;
    let timeLeft = 10; // タイマーの初期時間（秒）

    function generateM(maxTries = 20) {
      for (let i = 0; i < maxTries; i++) {
        let a = Math.floor(Math.random() * 199) + 2;  // 2〜200
        let b = Math.floor(Math.random() * 99) + 2;   // 2〜100
        if (b >= a) [a, b] = [b, a]; // a > b にする

        const operations = [
          { text: `${a} + ${b}`, value: a + b },
          { text: `${a} - ${b}`, value: a - b },
          { text: `${a} × ${b}`, value: a * b },
          { text: `${a} ÷ ${b}`, value: Math.floor(a / b) }
        ];

        const op = operations[Math.floor(Math.random() * operations.length)];
        const mVal = op.value;

        if (mVal > 1 && mVal <= 1000) {
          return { text: op.text, value: mVal };
        }
      }
      return null; // 失敗時
    }

    function generateQuestion() {
      const mObj = generateM();
      if (!mObj) {
        question.textContent = "問題の生成に失敗しました。ページを再読み込みしてください。";
        btn1.style.display = btn2.style.display = nextBtn.style.display = 'none';
        clearTimeout(timer);
        clearInterval(countdownTimer); // タイマー停止
        return;
      }

      m = mObj.value;
      const mText = mObj.text;
      const x = Math.floor(Math.random() * 10) + 1; // 1〜10
      n = 100 * x;

      if (Math.abs(m - n) >= 100 || m === n) {
        return generateQuestion(); // 条件を満たさなければ再帰
      }

      correctAnswer = m > n ? m : n;
      question.textContent = "大きいのはどっち？";

      const leftFirst = Math.random() < 0.5;
      if (leftFirst) {
        btn1.textContent = mText;
        btn2.textContent = n;
        btn1.dataset.value = m;
        btn2.dataset.value = n;
      } else {
        btn1.textContent = n;
        btn2.textContent = mText;
        btn1.dataset.value = n;
        btn2.dataset.value = m;
      }

      resetStyles();
      message.textContent = "";
      nextBtn.style.display = "none";
      timeLeft = 10;
      updateTimerDisplay();

      // タイマーのカウントダウン開始
      countdownTimer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();

        if (timeLeft <= 0) {
          clearInterval(countdownTimer); // タイマーを停止
          message.textContent = `時間切れです。正解は ${correctAnswer} です。`;
          markCorrect();
          streak = 0;
          updateStreak();
          nextBtn.style.display = "inline-block";
        }
      }, 1000);

      // 10秒後に自動で時間切れ処理
      timer = setTimeout(() => {
        clearInterval(countdownTimer); // タイマーを停止
        message.textContent = `時間切れです。正解は ${correctAnswer} です。`;
        markCorrect();
        streak = 0;
        updateStreak();
        nextBtn.style.display = "inline-block";
      }, 10000);
    }

    function updateTimerDisplay() {
      timerDisplay.textContent = `残り時間: ${timeLeft}秒`;
    }

    function handleAnswer(btn) {
      clearTimeout(timer);
      clearInterval(countdownTimer); // タイマーを停止
      const selected = parseInt(btn.dataset.value);
      const correct = selected === correctAnswer;
      if (correct) {
        message.textContent = "正解！";
        btn.classList.add("correct");
        streak++;
      } else {
        message.textContent = `不正解。正解は ${correctAnswer} です。`;
        btn.classList.add("incorrect");
        markCorrect();
        streak = 0;
      }
      updateStreak();
      disableButtons();
      nextBtn.style.display = "inline-block";
    }

    function markCorrect() {
      [btn1, btn2].forEach(b => {
        if (parseInt(b.dataset.value) === correctAnswer) {
          b.classList.add("correct");
        } else {
          b.classList.add("neutral");
        }
      });
    }

    function disableButtons() {
      btn1.disabled = true;
      btn2.disabled = true;
    }

    function resetStyles() {
      [btn1, btn2].forEach(b => {
        b.disabled = false;
        b.className = "";
      });
    }

    function updateStreak() {
      streakDisplay.textContent = `現在${streak}問連続正解中！`;
    }

    btn1.addEventListener("click", () => handleAnswer(btn1));
    btn2.addEventListener("click", () => handleAnswer(btn2));
    nextBtn.addEventListener("click", generateQuestion);

    generateQuestion();
  </script>
</body>
</html>
